
![](logo_dfMaker.png)


# `dfMaker` Function Documentation for OpenPose Data Processing

## Overview

The `dfMaker` function is a comprehensive tool designed for processing and organizing keypoints data generated by [OpenPose](https://github.com/CMU-Perceptual-Computing-Lab/openpose), a cutting-edge tool for real-time multi-person system to detect human body, hand, facial, and foot keypoints. This documentation details the function's usage, input parameters, the configuration file structure, and the algebraic definition of the data structure used for keypoints representation.

## Usage

Load the `dfMaker` function into your R session:

```r
load("./dfMaker/functionsRData/dfMaker.rda")
```

Below are several examples demonstrating different use cases:

### Basic Usage

Automatically process OpenPose JSON files and save the output with an auto-generated name based on unique IDs:

```r
dfMaker(input.folder = "./path/to/input")
```

### Saving to a Specific File

Process data and explicitly save it as a Parquet file:

```r
dfMaker(input.folder = "./path/to/input",
        output.file = "./path/to/outputs/processed_data.parquet")
```

For CSV output:

```r
dfMaker(input.folder = "./path/to/input",
        output.file = "./path/to/outputs/processed_data.csv")
```

### In-memory Processing Without Saving

Process files for in-memory use without saving to disk:

```r
example <- dfMaker(input.folder = "./path/to/input",
                   no_save = TRUE)
```

### Specifying Output Path

Define an output path for saving the processed file with an automatically generated name:

```r
dfMaker(input.folder = "./path/to/input",
        output.path = "./path/to/custom_output/")
```


### Parameters

- `input.folder`: The directory containing JSON files output by OpenPose. Each file should represent keypoints data for a single frame of video.
- `config.path`: Optional. The path to a JSON configuration file specifying which metadata fields to extract and include in the output. If not provided, default settings are used.
- `output.file`: Optional. Specifies the path and filename for the output file. If provided, the function writes the processed data to this file in either CSV or Parquet format, determined by the file extension. If not provided or empty, and multiple unique IDs are not found, the function automatically names the file based on the unique ID from the OpenPose data.
- `output.path`: Optional. Specifies the directory where the output file will be saved. If `output.file` is not provided or is empty, and there's exactly one unique ID in the processed data, the function automatically creates an output file named after the unique ID within this directory. If `output.path` is not specified, the function will create a default directory `./df_outputs/` to save the output file. This ensures organized storage of output files, especially useful when processing multiple datasets or running batch processes.

### Configuration File Structure

The configuration file is a JSON document that allows users to specify additional metadata to extract from the file names or directory structure. The structure of the configuration file is as follows:

```json
{
  "extract_datetime": false,
  "extract_time": false,
  "extract_exp_search": false,
  "extract_country_code": false,
  "extract_network_code": false,
  "extract_program_name": false,
  "extract_time_range": false,
  "timezone": "America/Los_Angeles"
}
```

Each field in the configuration file is a boolean that indicates whether the corresponding piece of metadata should be extracted. The `timezone` field specifies the timezone for datetime conversion.

## Algebraic Definition of \( M_{i,j} \) Matrix

For each person \( i \) and point type \( j \), the matrix \( M_{i,j} \) is defined as:

\[ M_{i,j} = \begin{pmatrix} x_{1,1} & y_{1,1} & c_{1,1} \\ x_{1,2} & y_{1,2} & c_{1,2} \\ \vdots & \vdots & \vdots \\ x_{K_j,N} & y_{K_j,N} & c_{K_j,N} \end{pmatrix} \]

Where:
- \( x_{k,n} \), \( y_{k,n} \), and \( c_{k,n} \) represent the X and Y coordinates and confidence value of the k-th keypoint for person \( i \) in point type \( j \).
- \( K_j \) is the total number of keypoints for point type \( j \), defined in `check_points[j]`.
- \( M_{i,j} \) is a matrix of size \( K_j \times 3 \).

## Functionality

`dfMaker` performs the following operations:
- Reads JSON files from `input.folder`, each representing keypoints data for individual frames produced by OpenPose.
- Processes each file according to the configurations specified in `config.path` (if provided).
- Constructs \( M_{i,j} \) matrices for each detected person and point type, organizing keypoints data into a structured format.
- Optionally extracts additional metadata based on file names and the specified configuration.
- Combines all processed data into a single dataframe.
- Outputs the consolidated data to `output.file` in the specified format (CSV or Parquet), automatically naming the file based on unique IDs if required.

## Output

The function returns a dataframe in R, containing the combined keypoints data from all processed frames, along with any extracted metadata. If `output.file` is specified, it also writes this data to a file in the chosen format.

This tool facilitates the detailed analysis of human poses, movements, and interactions, supporting research and development in areas such as motion analysis, computer vision, and interactive systems.


## Technical Requirements

To use the `dfMaker` function effectively, you will need the following:

### Software and Libraries
- **R Environment**: Ensure you have R installed on your system. You can download it from [The Comprehensive R Archive Network (CRAN)](https://cran.r-project.org/).
- **R Libraries**:
  - `arrow`: Required for reading JSON files and writing CSV or Parquet files. Install it using `install.packages("arrow")`.

### Installation

Before you can use the `dfMaker` function, you need to install the required R package if you haven't already. You can do this by running the following command in your R environment:

```r
install.packages("arrow")
```

Ensure that all the JSON files output by OpenPose are located in a single directory. This directory will be used as the input for the `input.folder` parameter.

## Collaboration and Inquiries

We welcome contributions and inquiries regarding the `dfMaker` function. Whether you're looking to improve the code, add functionality, or simply have questions about its use, we encourage you to get involved.

## Collaboration and Contributions

Contributions to improve `dfMaker` or extend its functionalities are welcome. To contribute:

1. Fork the repository.
2. Clone your fork and create a new branch for your feature or fix.
3. Make changes and test.
4. Submit a pull request with a comprehensive description of changes.


### Reporting Issues or Asking Questions

Encounter an issue or have questions? Check the documentation first. If unresolved, open an issue in the repository or reach out to the maintainers directly if contact information is provided.
